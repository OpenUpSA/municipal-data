{% extends '_base.html' %}
{% load staticfiles pipeline l10n jsonify %}

{% block head_title %}{{ geography.this.short_name }} - {{ block.super }}{% endblock %}
{% block head_meta_description %}Municipal performance for {{ geography.this.short_name}}, and other information.{% endblock %}

{% block head_facebook_tags %}
    <meta property="og:title" content="Municipal Money Profile: {% firstof geography.this.full_name geography.this.short_name %}" />
    <meta property="og:site_name" content="Municipal Money" />
    <meta property="og:description" content="Municipal performance for {{ geography.this.short_name}}, and other information." />
    <meta property="og:type" content="article" />
{% endblock %}

{% block head_css_extra %}
<link rel="stylesheet" href="{% static 'css/vendor/leaflet-0.6.4.css' %}" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="{% static 'css/vendor/leaflet-0.6.4.ie.css' %}" />
<![endif]-->
<link href="{% static 'css/vendor/leaflet.label.css' %}" rel="stylesheet" />
{% endblock %}
{% block body_id %}profile{% endblock %}

{% block header_content %}
  <div id="cover-map" class="clearfix">
    <div id="slippy-map"></div>
    <div id="cover-profile" class="container">
      <article class="clearfix column-half">
        <header id="header-box" class="column-full">
          <h1 class="title">{{ geography.this.short_name }}</h1>
          <p class="caption">
            {{ geography.this.geo_level|capfirst }}
            in
            {% if geography.parents %}
              {% for level, g in geography.parents.items %}
                <a href="/profiles/{{ g.full_geoid }}-{{ g.short_name|slugify }}/">{{ g.short_name }}</a>,
              {% endfor %}
            {% endif %}
            {{ geography.this.province_name }}
          </p>
        </header>
        <div class="stat stat-primary">
          <span class="name">Population</span>
          <span class="value">{{ total_population|floatformat:"0" }}</span>
        </div>
        {% if geography.this.square_kms %}
        <div class="stat stat-secondary">
          <span class="value">{% if geography.this.square_kms < 1.0 %}{{ geography.this.square_kms|floatformat:"3" }}{% else %}{{ geography.this.square_kms|floatformat:"1" }}{% endif %}</span>
          <span class="name"> square kilometres</span>
        </div>
          {% if population_density %}
          <div class="stat stat-secondary">
            <span class="value">{{ population_density|floatformat:"1" }}</span>
            <span class="name"> people per square kilometre</span>
          </div>
          {% endif %}
        {% endif %}
      </article>
    </div>
  </div>

  <div id="about">
    <div class="container">
      <div class="sub-section" id="who-runs">
        <div class="row">
          <div class="col-md-4 col-md-push-8">
            <ul class="fa-ul">
              <li>
                <i class="fa fa-li fa-phone" aria-hidden="true"></i> <a href="tel:{{ muni_contact.phone_number }}">{{ muni_contact.phone_number }}</a>
              </li>
              {% if muni_contact.url %}
              <li>
                <i class="fa fa-li fa-globe" aria-hidden="true"></i> <a href="{{ muni_contact.url|lower }}">{{ muni_contact.url }}</a>
              </li>
              {% endif %}
              <li>
                <i class="fa fa-li fa-map-marker" aria-hidden="true"></i>
                {{ muni_contact.street_address_1 }}<br>
                {{ muni_contact.street_address_2 }}<br>
                {{ muni_contact.street_address_3 }}<br>
                {{ muni_contact.street_address_4 }}
              </li>
            </ul>
          </div>
          <div class="col-md-8 col-md-pull-4">
            <div class="row">
              {% for official in mayoral_staff %}
                {% if forloop.counter < 5 %}
                <div class="col-sm-3">
                  <div class="person-info">
                    <div class="person-role">{{ official.role }}</div>
                    <ul class="fa-ul person-name">
                      <li><i class="fa fa-li fa-user" aria-hidden="true"></i> {{ official.title }} {{ official.name }}</li>
                    </ul>
                    <div class="person-contact-details">
                      <a href="#contact-details-{{ forloop.counter }}" data-toggle="collapse" class="show-contact-details show-more"><span class="icon"><i class="fa fa-plus" aria-hidden="true"></i></span> Contact Details</a>
                      <div class="contact-details collapse" id="contact-details-{{ forloop.counter }}">
                        {% if official.secretary %}
                        <div>
                          <h4>Secretary</h4>
                          {{ official.secretary.title }} {{ official.secretary.name }}
                        </div>
                        {% endif %}

                        {% with details=official.secretary|default:official %}
                          <ul class="fa-ul">
                            <li>
                              <i class="fa fa-li fa-phone" aria-hidden="true"></i> <a href="tel:{{ details.office_phone }}">{{ details.office_phone }}</a>
                            </li>
                            <li>
                              <i class="fa fa-li fa-envelope" aria-hidden="true"></i> <a href="{{ details.email }}">{{ details.email }}</a>
                            </li>
                          </ul>
                        {% endwith %}
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

    {% block page-nav %}
        <div class="page-nav-wrapper">
          <div class="page-nav-container">
            <div class="container">
              <div class="page-nav-info">
                <div class="muni-name">{{ geography.this.short_name }}</div>
                <div class="muni-population">Population: {{ total_population|floatformat:"0" }}</div>
              </div>

              <ul class="nav nav-pills" id="page-nav">
                <li role="presentation" class="active"><a href="#performance"><div class="icon icon-office-16"></div><span class="nav-text">Performance</span></a></li>
                <li role="presentation"><a href="#"><div class="icon icon-office-42"></div><span class="nav-text">Income</span></a></li>
                <li role="presentation"><a href="#"><div class="icon icon-shopping-03"></div><span class="nav-text">Spending</span></a></li>
              </ul>

            </div>
          </div>
        </div>
    {% endblock %}
{% endblock %}

{% block content %}

<div class="section" id="performance">
  <h1><div class="icon icon-office-16"></div> Performance</h1>

  <div class="indicator">
    <h2>Audit outcomes</h2>

    <div class="row">

      <div class="col-sm-8">
        <div class="row">
        {% for opinion in audit_opinions %}
          <div class="col-sm-3">
            <table class="table table-bordered">
              <tr>
                <td class="text{% if forloop.first %}-large{% endif %} text-center"><strong>{{ opinion.year|unlocalize }} <i class="fa {% if opinion.rating == 'good' %}fa-thumbs-up indicator-good{% elif opinion.rating == 'ave' %}fa-thumbs-up indicator-ave{% else %}fa-warning indicator-bad{% endif %}" aria-hidden="true"></i><br>{{ opinion.result }}</strong></td>
              </tr>
              <tr class="table-footer">
                <td><a href="#">Read report</a></td>
              </tr>
            </table>
          </div>
        {% endfor %}
        </div>
      </div>

      <div class="col-sm-4">
        <div class="panel panel-didyouknow">
          <div class="panel-heading"><i class="fa fa-info-circle" aria-hidden="true"></i> Did you know?</div>
          <div class="panel-body">
            There are <strong>5 types of audit outcomes</strong>:
            <ul>
              <li><strong>Unqualified - No findings Outstanding:</strong> An opinion in which the financial  statements of the municipality fairly represent the financial position of the municipality and are in line with Generally Recognised Accounting Practices (GRAP). </li>
            </ul>
            <div class="more">
              <a href="#more-audit-opinions" data-toggle="collapse" class="show-more-audit-opinions show-more"><span class="icon"><i class="fa fa-plus" aria-hidden="true"></i></span> Show More</a>
            </div>
            <div class="more-audit-opinions collapse" id="more-audit-opinions">
              <ul>
                <li><strong>Unqualified - No findings</strong>  is one in which the Auditor-General can state, without reservation, that the financial  statements of the municipality fairly represent the financial position of the municipality and are in line with Generally Recognised Accounting Practices (GRAP)</li>
                <li><strong>Unqualified - Emphasis of Matter items</strong> Same as an unqualified opinion with no findings, but modified without affecting the status of the opinion on the financial statement of the municipality.</li>
                <li><strong>A Qualified opinion</strong>: Expresses reservations by the Auditor-General about the fair presentation of the financial statements. These are expressed when some scope limitation or a departure from Generally Recognised Accounting Practices (GRAP) exists but is not sufficiently serious as to warrant an adverse opinion or disclaimer of opinion. One common reason for a qualified opinion may be an insufficiency of the underlying financial records to support some of the data in the financial statements. In this case the Auditor-General may conclude that the financial statements are presented fairly except for the insufficiently supported data.</li>
                <li><strong>An Adverse opinion</strong> is expressed when the auditor concludes that the annual financial statements do not present the municipalityâ€™s financial position, results of operations and cash flows in line with Generally Recognised Accounting Practices (GRAP)  It is only issued in situations where financial statements contain serious departures from GRAP and the qualification of annual financial statements is not sufficient to disclose the misleading or incomplete nature of the financial statements.</li>
                <li><strong>A Disclaimer of opinion</strong> is issued when the Auditor-General does not have all of the underlying documentation needed to determine an opinion about whether the financial statements are fairly presented. For example, at some point the lack of underlying documentation and the amounts in question may be so great so that it is impossible to give any opinion on all, or a significant portion of the financial statements.</li>
                <li><strong>An Outstanding opinion</strong> means that the Auditor General raised queries with the municipality and therefore has not submitted another opinion.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="indicator">
    <h2 class="sub-heading">Cash balance</h2>

    <div class="row">
      <div class="col-sm-4">
        {% with indicators.cash_at_year_end|first as latest %}
        <div class="indicator-date">{{ latest.year|unlocalize }}</div>
        <div class="indicator-value indicator-{{ latest.rating }}">{% if latest.result %}R {{ latest.result|floatformat:"0" }} {% else %} N/A {% endif %} <i class="fa {% if latest.rating == 'good' or latest.rating == 'ave' %}fa-check{% else %}fa-warning{% endif %}" aria-hidden="true"></i></div>
        {% endwith %}
        <div class="indicator-description">cash balance at the end of the financial year.</div>
        <table class="table table-bordered indicator-key">
          <tr>
            <td class="key-symbol indicator-good">good <i class="fa fa-check" aria-hidden="true"></i></td>
            <td class="key-description">Positive balance</td>
          </tr>
          <tr>
            <td class="key-symbol indicator-bad">bad <i class="fa fa-warning" aria-hidden="true"></i></td>
            <td class="key-description">Negative balance.</td>
          </tr>
        </table>
      </div>
      <div class="col-sm-4">
        <div class="cash-at-year-end chart-container"></div>
      </div>
      <div class="col-sm-4">
        <div class="panel panel-didyouknow">
          <div class="panel-heading"><i class="fa fa-info-circle" aria-hidden="true"></i> Did you know?</div>
          <div class="panel-body">
            In terms of section 45 of the MFMA, municipalities are not permitted to close the financial year with any short-term borrowing or overdraft. The fact that a municipality is not able to close the financial year with positive cash positions, is a very strong indicator that these municipality is in financial distress at that date.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="indicator">
    <h2>Cash coverage</h2>

    <div class="row">
      <div class="col-sm-4">
        {% with indicators.cash_coverage|first as latest %}
        <div class="indicator-date">{{ latest.year|unlocalize }}</div>
        <div class="indicator-value indicator-{{ latest.rating }}">{% if latest.result %}{{ latest.result }} months{% else %} N/A {% endif %} <i class="fa {% if latest.rating == 'good' or latest.rating == 'ave' %}fa-check{% elif latest.rating == 'bad' %}fa-warning{% endif %}" aria-hidden="true"></i></div>
        {% endwith %}
        <div class="indicator-description">months of operating expenses can be paid for with the cash available.</div>
        <table class="table table-bordered indicator-key">
          <tr>
            <td class="key-symbol indicator-good">good <i class="fa fa-check" aria-hidden="true"></i></td>
            <td class="key-description">more than 3</td>
          </tr>
          <tr>
            <td class="key-symbol indicator-bad">bad <i class="fa fa-warning" aria-hidden="true"></i></td>
            <td class="key-description">less than 1</td>
          </tr>
        </table>
      </div>
      <div class="col-sm-4">
        <div class="cash-coverage chart-container"></div>
      </div>
      <div class="col-sm-4">
        <div class="panel panel-didyouknow">
          <div class="panel-heading"><i class="fa fa-info-circle" aria-hidden="true"></i> Did you know?</div>
          <div class="panel-body">
            A <strong>low value</strong> shows that the municipality may be unable to pay for the day-to-day expenses.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="indicator">
    <h2>Spending of Operating Budget</h2>

    <div class="row">
      <div class="col-sm-4">
        {% with indicators.op_budget_diff|first as latest %}
        <div class="indicator-date">{{ latest.year|unlocalize }}</div>
        <div class="indicator-value indicator-{{ latest.rating }}">{% if latest.result %}{{ latest.result }}% {% else %} N/A {% endif %} <i class="fa {% if latest.rating == 'good' or latest.rating == 'ave' %}fa-check{% else %}fa-warning{% endif %}" aria-hidden="true"></i></div>
        {% endwith %}
        <div class="indicator-description">difference between operating budget and actual expenditure.</div>
        <table class="table table-bordered indicator-key">
          <tr>
            <td class="key-symbol indicator-good">good <i class="fa fa-check" aria-hidden="true"></i></td>
            <td class="key-description">less than 10%</td>
          </tr>
          <tr>
            <td class="key-symbol indicator-bad">bad <i class="fa fa-warning" aria-hidden="true"></i></td>
            <td class="key-description">more than 25%</td>
          </tr>
        </table>
      </div>
      <div class="col-sm-4">
        <div class="op-budget-diff chart-container"></div>
      </div>
    </div>
  </div>

  <div class="indicator">
    <h2>Spending of Capital Budget</h2>

    <div class="row">
      <div class="col-sm-4">
        {% with indicators.cap_budget_diff|first as latest %}
        <div class="indicator-date">{{ latest.year|unlocalize }}</div>
        <div class="indicator-value indicator-{{ latest.rating }}">{% if latest.result %}{{ latest.result }}% {% else %} N/A {% endif %} <i class="fa {% if latest.rating == 'good' or latest.rating == 'ave' %}fa-check{% else %}fa-warning{% endif %}" aria-hidden="true"></i></div>
        {% endwith %}
        <div class="indicator-description">difference between capital budget and actual expenditure.</div>
        <table class="table table-bordered indicator-key">
          <tr>
            <td class="key-symbol indicator-good">good <i class="fa fa-check" aria-hidden="true"></i></td>
            <td class="key-description">less than 10%</td>
          </tr>
          <tr>
            <td class="key-symbol indicator-bad">bad <i class="fa fa-warning" aria-hidden="true"></i></td>
            <td class="key-description">more than 30%</td>
          </tr>
        </table>
      </div>
      <div class="col-sm-4">
        <div class="cap-budget-diff chart-container"></div>
      </div>
    </div>
  </div>

  <div class="indicator">
    <h2>Spending on Repairs and Maintenance</h2>

    <div class="row">
      <div class="col-sm-4">
        {% with indicators.rep_maint_perc_ppe|first as latest %}
        <div class="indicator-date">{{ latest.year|unlocalize }}</div>
        <div class="indicator-value indicator-{{ latest.rating }}">{% if latest.result %}{{ latest.result }}% {% else %} N/A {% endif %} <i class="fa {% if latest.rating == 'good' or latest.rating == 'ave' %}fa-check{% elif latest.rating == 'bad' %}fa-warning{% endif %}" aria-hidden="true"></i></div>
        {% endwith %}

        <div class="indicator-description">Spending on Repairs and Maintenance as a percentage of Property, Plant and Equipment.</div>
        <table class="table table-bordered indicator-key">
          <tr>
            <td class="key-symbol indicator-good">good <i class="fa fa-check" aria-hidden="true"></i></td>
            <td class="key-description">more than 8%</td>
          </tr>
          <tr>
            <td class="key-symbol indicator-bad">bad <i class="fa fa-warning" aria-hidden="true"></i></td>
            <td class="key-description">less than 8%</td>
          </tr>
        </table>
      </div>
      <div class="col-sm-4">
        <div class="rep-maint-perc-ppe chart-container"></div>
      </div>
    </div>
  </div>

</div>

{% endblock %}

{% block body_javascript_extra %}
<script src="{% static 'js/vendor/leaflet-0.6.4.js' %}"></script>
<script src="{% static 'js/vendor/topojson.v1.min.js' %}"></script>
<script src="{% static 'js/vendor/leaflet.label.js' %}"></script>
<script src="{% static 'js/head2head.js' %}"></script>
<script src="{% static 'js/maps_static.js' %}"></script>
<script src="{% static 'js/maps_mapit.js' %}"></script>
<script src="{% static 'js/profile_map.js' %}"></script>
<script src="{% static 'js/profile_map_mapit.js' %}"></script>

<script type="text/javascript">

  var profileData = {{ profile_data_json }};
  var maps = new ProfileMaps();
  maps.drawMapsForProfile(profileData.geography);

  var CASH_AT_YEAR_END = {{ indicators.cash_at_year_end|jsonify|safe }}
  var CASH_COVERAGE = {{ indicators.cash_coverage|jsonify|safe }}
  var OP_BUDGET_DIFF = {{ indicators.op_budget_diff|jsonify|safe }}
  var CAP_BUDGET_DIFF = {{ indicators.cap_budget_diff|jsonify|safe }}
  var REP_MAINT_PERC_PPE = {{ indicators.rep_maint_perc_ppe|jsonify|safe }}

</script>

{% javascript "scorecard" %}
{% endblock %}
